<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
	"http://www.w3.org/TR/html4/strict.dtd">
<html lang="">
	<head>
<meta charset='utf-8' />
		<title>MiMapa</title>
<meta name='viewport' content='initial-scale=1, maximum-scale=1, user-scalable=no, 
shrink-to-fit=no, width=device-width, height=device-height' />
<script src="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css" rel="stylesheet" />
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
<link rel="stylesheet" type="text/css" href="https://widgets.elpais.com/mapbox/2020/09/mapa-madrid/style.css?vv=2">
</head>
<body><script type="text/javascript">PEPuid='W9g/71+6wD5njE6fIP9ZAg==';</script><div id="pxlhddncntrl" style="display:none"><script src="//ep00.epimg.net/js/prisa/user.js?i=1"></script><script src="//ep00.epimg.net/js/comun/comun.js"></script></div>
<script
    src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v2.3.0/mapbox-gl-geocoder.min.js'></script>
<link rel='stylesheet'
    href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v2.3.0/mapbox-gl-geocoder.css'
type='text/css'/>
<div class="map-container">
<div id="map"></div>
<div id="filters-panel">
<div id="details" class="buttons">
<button type="button" name="button" class="active">Restringidas</button>
<button type="button" name="button">Más 500</button>
<button type="button" name="button">Todas</button>
<button type="button" name="button">Cambio 14 días</button>
</div>
<script>
        mapboxgl.accessToken = 'pk.eyJ1IjoiZWxwYWlzbGFiIiwiYSI6ImNqbmRmZHB4cjA3MDYzcG80eTkxNThrMmIifQ.Q2nDlfQEHfZDwimIMPZE5g';
        var hoveredStateId = null;
        var searched_lngLat = null;
        const to_ES = (number, digits = 1) => number.toLocaleString("es", {
          minimumFractionDigits: digits,
          maximumFractionDigits: digits
        })

        // load map
        var map = new mapboxgl.Map({
          container: 'map', // container id    
          //style: 'mapbox://styles/elpaislab/cjul60ddh06n71fnx9zg7bgrj',
          style: 'mapbox://styles/elpaislab/ckc54sbeh1cc91imxk07hbeeg',
          center: [-3.629374,40.407401],// starting position [lng, lat]
          zoom: 15, // starting zoom
          minZoom: 1,
          maxZoom: 15,
          attributionControl: false,
          maxBounds: [[-5.16, 39.5], [-2.1912, 41.2033]]
        });

        // add controler
        map.addControl(new mapboxgl.AttributionControl({ compact: true }), 'bottom-right');

        // Add zoom and rotation controls to the map.
        var nav = new mapboxgl.NavigationControl({ showCompass: false });
        map.addControl(nav, 'bottom-left');

        // geocoder
        var geocoder = new MapboxGeocoder({
          accessToken: mapboxgl.accessToken,
          country: 'es',
          //types: 'place',
          placeholder: 'Busca tu calle',
          bbox: [-5.16, 39.8479, -2.1912, 41.2033],
          zoom: 14,
        });
        map.addControl(geocoder, 'top-right');

        map.on('load', function () {

          // capas
          map.addSource("tiles_zbs_map", {
            type: 'vector',
            url: 'mapbox://elpaislab.3dgh7y0o',
          });

          map.addSource("tiles_munis_map", {
            type: 'vector',
            url: 'mapbox://elpaislab.4jjc30dp',
          });

          // capa con geometrías
          map.addLayer({
            id: 'tiles-tendencia',
            source: 'tiles_zbs_map',
            type: 'fill',
            'layout': { visibility: 'visible' },
            'source-layer': 'to_mapbox',
            'paint': {
              'fill-color': {
                property: 'tendencia',
                type: 'interval',
                stops: [[-1000, '#00d07d'], [-10, '#ffad16'], [10, '#f03147']]
              }
            }
          }, "water");


          // capa con geometrías
          map.addLayer({
            id: 'tiles-restringidos',
            source: 'tiles_zbs_map',
            type: 'fill',
            'layout': { visibility: 'visible' },
            'source-layer': 'to_mapbox',
            'paint': {
              'fill-color': ['interpolate',
                ["linear", 1],
                ['get', 'incidence_14_color'],
                -100,
                '#ededed',
                0,
                '#66bd63',
                5,
                '#a6d96a',
                25,
                '#d9ef8b',
                50,
                '#ffffbf', //amarillo
                100,
                '#fee08b',
                300,
                '#fdae61',
                600,
                '#f46d43',
                1200,
                '#d73027',
                1500,
                '#a50026']
            }
          }, "water");

          // capa con geometrías
          map.addLayer({
            id: 'tiles-todos',
            source: 'tiles_zbs_map',
            type: 'fill',
            'layout': { visibility: 'none' },
            'source-layer': 'to_mapbox',
            'paint': {
              'fill-color': ['interpolate',
                ["linear", 1],
                ['get', 'incidence_14'],
                -100,
                '#ededed',
                0,
                '#66bd63',
                5,
                '#a6d96a',
                25,
                '#d9ef8b',
                50,
                '#ffffbf', //amarillo
                100,
                '#fee08b',
                300,
                '#fdae61',
                600,
                '#f46d43',
                1200,
                '#d73027',
                1500,
                '#a50026']
            }
          }, "water");


          map.addLayer({
            id: 'tiles-1000',
            source: 'tiles_zbs_map',
            type: 'fill',
            'layout': { visibility: 'none' },
            'source-layer': 'to_mapbox',
            'paint': {
              //'fill-opacity': ["case", [">=", ['get', 'incidence_14'], 1000], 1, 0],
              'fill-color':
                ["case", ["<", ['get', 'incidence_14'], 1000],
                  "#ededed",
                  ['interpolate',
                    ["linear", 1],
                    ['get', 'incidence_14'],
                    -100,
                    '#ededed',
                    0,
                    '#66bd63',
                    5,
                    '#a6d96a',
                    25,
                    '#d9ef8b',
                    50,
                    '#ffffbf', //amarillo
                    100,
                    '#fee08b',
                    300,
                    '#fdae61',
                    600,
                    '#f46d43',
                    1200,
                    '#d73027',
                    1500,
                    '#a50026']
                ]
            }
          }, "water");


          map.addLayer({
            id: 'tiles-500',
            source: 'tiles_zbs_map',
            type: 'fill',
            'layout': { visibility: 'none' },
            'source-layer': 'to_mapbox',
            'paint': {
              //'fill-opacity': ["case", [">=", ['get', 'incidence_14'], 1000], 1, 0],
              'fill-color':
                ["case", ["<", ['get', 'incidence_14'], 500],
                  "#ededed",
                  ['interpolate',
                    ["linear", 1],
                    ['get', 'incidence_14'],
                    -100,
                    '#ededed',
                    0,
                    '#66bd63',
                    5,
                    '#a6d96a',
                    25,
                    '#d9ef8b',
                    50,
                    '#ffffbf', //amarillo
                    100,
                    '#fee08b',
                    300,
                    '#fdae61',
                    600,
                    '#f46d43',
                    1200,
                    '#d73027',
                    1500,
                    '#a50026']
                ]
            }
          }, "water");




          // detector de hover
          map.addLayer({
            id: 'tiles-hover',
            source: 'tiles_zbs_map',
            type: 'fill',
            'source-layer': 'to_mapbox',
            'paint': {
              'fill-opacity': 0
            }
          }, "water");


          // detector de hover
          map.addLayer({
            id: 'tiles-munis-hover',
            source: 'tiles_munis_map',
            type: 'fill',
            'source-layer': 'to_mapbox_munis',
            'paint': {
              'fill-opacity': 0
            }
          }, "water");

          // capa con bordes (reactiva a hover)
          map.addLayer({
            id: 'tiles-borders',
            source: 'tiles_zbs_map',
            type: 'line',
            'source-layer': 'to_mapbox',
            'paint': {
              "line-color": ["case", ["boolean", ["feature-state", "hover"], true], "black", "white"],
              "line-width": ["case", ["boolean", ["feature-state", "hover"], false], 2, 0]
            }
          });

          // Create a popup, but don't add it to the map yet
          var popup = new mapboxgl.Popup({
            closeButton: false,
            closeOnClick: false,
            anchor: "top",
            offset: 30
          });

          // Boton de cambiar de capa
          var touchClickEv = "ontouchend" in window ? "touchend" : "click";
          document.querySelector("#details button").classList.add('active')

          document.querySelectorAll("#details button").forEach(function (button) {
            button.addEventListener(touchClickEv, updateMap)


          })

          function updateMap(e) {

            document.querySelectorAll("#details button").forEach(function (button) {
              button.classList.remove('active')
            });

            this.classList.add('active')
            var activado = document.querySelector("button.active").innerHTML

            if (activado === 'Todas') {
              map.setLayoutProperty('tiles-restringidos', 'visibility', 'none');
              map.setLayoutProperty('tiles-500', 'visibility', 'none');
              map.setLayoutProperty('tiles-tendencia', 'visibility', 'none');
              map.setLayoutProperty('tiles-todos', 'visibility', 'visible');
            } else if (activado === 'Más 500') {
              map.setLayoutProperty('tiles-restringidos', 'visibility', 'none');
              map.setLayoutProperty('tiles-tendencia', 'visibility', 'none');
              map.setLayoutProperty('tiles-todos', 'visibility', 'none');
              map.setLayoutProperty('tiles-500', 'visibility', 'visible');
            } else if (activado === 'Cambio 14 días') {
              map.setLayoutProperty('tiles-restringidos', 'visibility', 'none');
              map.setLayoutProperty('tiles-500', 'visibility', 'none');
              map.setLayoutProperty('tiles-todos', 'visibility', 'none');
              map.setLayoutProperty('tiles-tendencia', 'visibility', 'visible');
            } else {
              map.setLayoutProperty('tiles-500', 'visibility', 'none');
              map.setLayoutProperty('tiles-tendencia', 'visibility', 'none');
              map.setLayoutProperty('tiles-todos', 'visibility', 'none');
              map.setLayoutProperty('tiles-restringidos', 'visibility', 'visible');
            }

          }


          map.on('mousemove', "tiles-hover", function (e) {

            var point = map.project(e.lngLat)
            var featureMuni = map.queryRenderedFeatures(point, { layers: ['tiles-munis-hover'] })

            if (e.features.length > 0) {

              if (hoveredStateId) {
                map.setFeatureState({
                  source: 'tiles_zbs_map',
                  sourceLayer: 'to_mapbox',
                  id: hoveredStateId
                }, { hover: false });
              }

              hoveredStateId = e.features[0].id;
              map.setFeatureState({
                source: 'tiles_zbs_map',
                sourceLayer: 'to_mapbox',
                id: hoveredStateId
              }, { hover: true });

              popup.setLngLat(e.lngLat)
                .setHTML(
                  "<div class='munis-info'><p>" +
                  featureMuni[0].properties.mun +
                  "<p>Incidencia: " + to_ES(featureMuni[0].properties.incidence_mun_14, 0) +
                  " <span class='" + featureMuni[0].properties.tendencia_css + "'>" + to_ES(featureMuni[0].properties.incidence_mun_14_14d) + "</span></p>" +
                  "<p class='small text-muted'>casos por 100.000 hab. en 14 días</p></div>" +
                  "<p><large>Zona: <strong>" + e.features[0].properties.zbs + "</strong></p>" +
                  "<p>" + (e.features[0].properties.restringido ?
                    "<span style='color:#ff4141; font-weight:600'>Restringida</span>" :
                    "") + "</p>" +
                  "<p>Incidencia: " + to_ES(e.features[0].properties.incidence_14, 0) +                   
                  " <span class='" + e.features[0].properties.tendencia_css + "'>" + to_ES(e.features[0].properties.incidence_14_14d) + "</span></p>"
                ).addTo(map);
            }

          });

          // Escuchar geocoder si devuelve resultado y guardar destino
          geocoder.on('result', function (ev) {
            searched_lngLat = mapboxgl.LngLat.convert(ev.result.center)
          });

          // cuando se mueve al destino, actualizar
          map.on('moveend', function () {
            if (searched_lngLat) {
              var point = map.project(searched_lngLat)
              var features = map.queryRenderedFeatures(point, { layers: ['tiles-hover'] })
              var featuresMuni = map.queryRenderedFeatures(point, { layers: ['tiles-munis-hover'] })
              if (features.length > 0) {

                if (hoveredStateId) {
                  map.setFeatureState({
                    source: 'tiles_zbs_map',
                    sourceLayer: 'to_mapbox',
                    id: hoveredStateId
                  }, { hover: false });
                }
                hoveredStateId = features[0].id;
                map.setFeatureState({
                  source: 'tiles_zbs_map',
                  sourceLayer: 'to_mapbox',
                  id: hoveredStateId
                }, { hover: true });

                popup.setLngLat(searched_lngLat)
                .setHTML(
                  "<div class='munis-info'><p>" +
                    featuresMuni[0].properties.mun +
                  "<p>Incidencia: " + to_ES(featuresMuni[0].properties.incidence_mun_14, 0) +
                  " <span class='" + featuresMuni[0].properties.tendencia_css + "'>" + to_ES(featuresMuni[0].properties.incidence_mun_14_14d) + "</span></p>" +
                  "<p class='small text-muted'>casos por 100.000 hab. en 14 días</p></div>" +
                  "<p><large>Zona: <strong>" + features[0].properties.zbs + "</strong></p>" +
                  "<p>" + (features[0].properties.restringido ?
                    "<span style='color:#ff4141; font-weight:600'>Restringida</span>" :
                    "") + "</p>" +
                  "<p>Incidencia: " + to_ES(features[0].properties.incidence_14, 0) +                   
                  " <span class='" + features[0].properties.tendencia_css + "'>" + to_ES(features[0].properties.incidence_14_14d) + "</span></p>"
                ).addTo(map);
              }
              searched_lngLat = null;
            }
          });


        });

      </script>
</body>
</html>